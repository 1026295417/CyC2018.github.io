您好，我是今天（10.13）下午两点左右参加字节跳动第三轮面试的应聘者郑永川。

在这次面试过程中您提出了一个座位乱排的问题，这道问题我最开始给出了一个解决思路，但是被您否决了，所以在这个问题上我的思考时间会比较长，而且最后也没有给出您想要的答案。

我在查阅资料并且写代码验证之后，证实了我之前提供的递推公式是正确的，递推公式是 dp[i] = (i-1)(dp[i-1] + dp[i-2])。我觉得您说的那个递推公式也有道理，但是因为您没有给我第二个 dp 状态是怎么转移的，所以我没有进行验证。

在查阅资料之后，我发现这是一个典型的错排问题，主要参考的资料是 [维基百科](https://zh.wikipedia.org/zh-hans/%E9%94%99%E6%8E%92%E9%97%AE%E9%A2%98)，资料里面的递推公式和我的一样。为了验证是否正确，我写了以下回溯代码进行验证：

```java
public class Derangement {

    private static int cnt = 0;

    public static void main(String[] args) {
        for (int n = 3; n <= 7; n++) {
            cnt = 0;
            backtracking(new boolean[n], new ArrayList<>(), n);
            System.out.println(cnt);
        }
    }

    private static void backtracking(boolean[] used, List<Integer> list, int n) {
        if (list.size() == n) {
            if (check(list)) {
                cnt++;
            }
            return;
        }
        for (int i = 0; i < used.length; i++) {
            if (used[i]) continue;
            used[i] = true;
            list.add(i);
            backtracking(used, list, n);
            list.remove(list.size() - 1);
            used[i] = false;
        }
    }

    private static boolean check(List<Integer> list) {
        for (int i = 0; i < list.size(); i++) {
            if (list.get(i) == i) return false;
        }
        return true;
    }
}
```

这段代码输出从第 3 到第 7 的状态值，输出结果是：

```html
2
9
44
265
1854
```

很容易知道 dp[1] = 0，dp[2] = 1，如果使用 dp[i] = (i-1)(dp[i-1] + dp[i-2]) 这个递推公式，得到 dp 从 3 到 7 的值如下：

| n | dp |
| --- | --- |
| 1 | 0 |
| 2 | 1 |
| 3 | 2\*(0+1) = 2 |
| 4 | 3\*(1+2) = 9 |
| 5 | 4\*(2+9) = 44 |
| 6 | 5\*(9+44) = 265 |
| 7 | 6\*(44256) = 1854 |

可以看到这个递推公式是正确的。

对于这个问题，我的整体思路是，首先第 1 座位上的人为 x，第 x 个座位上的人为 y，根据 y 是否等于 1，可以分成两种情况讨论。

- 相等：交换这两个座位上的人，剩下的 i - 2 个人可以当成一个子问题单独考虑，而 x 可以有 i - 1 种取值，因此是 (i-1)\*dp[i-2]；
- 不想等：将第 1 和第 x 座位上的人交换座位，此时第 1 个座位上的人为 y，第 x 座位上的人为 x，那么排除第 x 个座位之后，剩下 i - 1 个座位有 dp[i-1] 种错排方式。由于 x 也有 i -1，因此为 (i-1)\*dp[i-1]。

我们讨论的重点在于不想等情况下的转移方程，在交换第 1 和第 x 座位上的人后，第 1 个座位上的人为 y，这个 y 没有影响到其它状态，因此可以将这个 y 看成是任意一个，因此排除第 x 个座位之后剩下的 i - 1 个座位的求解可以当成一个子问题进行，不影响其它的状态。

在这个问题上我花了很长时间，主要是因为我一直都觉得自己的思路是对的，没有想出哪里有问题。我知道如果这个问题我做错了，那么我的面试评分会很低，很有可能没办法通过考核，也就没能加入字节跳动，而我又非常想加入，因此现在打扰您，向您说明一下我最开始其实就想出了正确的解答，也希望您能修改一下在这个问题上我的面试评分，谢谢！